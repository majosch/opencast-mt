FROM alpine:3.7

RUN apk add --no-cache \
       openjdk8 \
       bash su-exec openssl tzdata curl jq \
       fontconfig ttf-dejavu ttf-freefont ttf-liberation ttf-linux-libertine \
       ffmpeg sox hunspell tesseract-ocr sudo

ARG OPENCAST_ADMIN_URL="http://oc-admin:8080"
ARG TENANT1_ID="tenant1"
ARG TENANT1_NAME="Tenant 1"
ARG TENANT2_ID="tenant2"
ARG TENANT2_NAME="Tenant 2"
ARG PROP_ORG_OPENCASTPROJECT_TENANT1_ADMIN_UI_URL="http://oc1-admin:8080"
ARG PROP_ORG_OPENCASTPROJECT_TENANT2_ADMIN_UI_URL="http://oc2-admin:8080"
ARG OPENCAST_PRESENTATION_URL="http://oc-presentation:8080"
ARG PROP_ORG_OPENCASTPROJECT_TENANT1_PRESENTATION_UI_URL="http://oc1-presentation:8080"
ARG PROP_ORG_OPENCASTPROJECT_TENANT2_PRESENTATION_UI_URL="http://oc2-presentation:8080"
ARG ORG_OPENCASTPROJECT_DOWNLOAD_URL="http://oc-admin:8080"
ARG PROP_ORG_OPENCASTPROJECT_FILE_REPO_URL="http://oc-admin:8080"
ARG ORG_OPENCASTPROJECT_SECURITY_ADMIN_USER="admin"
ARG ORG_OPENCASTPROJECT_SECURITY_ADMIN_PASS="opencast"
ARG ORG_OPENCASTPROJECT_ADMIN_EMAIL="admin@localhost"
ARG ORG_OPENCASTPROJECT_SECURITY_DIGEST_USER="opencast_system_account"
ARG ORG_OPENCASTPROJECT_SECURITY_DIGEST_PASS="opencast"
ARG OPENCAST_DATA="/data"
ARG ORG_OPENCASTPROJECT_DB_DDL_GENERATION="false"
ARG ORG_OPENCASTPROJECT_DB_VENDOR="MySQL"
ARG ORG_OPENCASTPROJECT_DB_JDBC_DRIVER="com.mysql.jdbc.Driver"
ARG ORG_OPENCASTPROJECT_DB_JDBC_URL="jdbc:mysql://mariadb/opencast"
ARG ORG_OPENCASTPROJECT_DB_JDBC_USER="opencast"
ARG ORG_OPENCASTPROJECT_DB_JDBC_PASS="opencast"
ARG ACTIVEMQ_BROKER_URL="failover://(tcp://activemq:61616)?initialReconnectDelay=2000&maxReconnectAttempts=2"
ARG ACTIVEMQ_BROKER_USERNAME="opencast"
ARG ACTIVEMQ_BROKER_PASSWORD="opencast"

ENV OPENCAST_ADMIN_URL=$OPENCAST_ADMIN_URL \
    TENANT1_ID=$TENANT1_ID \
    TENANT1_NAME=$TENANT1_NAME \
    TENANT2_ID=$TENANT2_ID \
    TENANT2_NAME=$TENANT2_NAME \
    PROP_ORG_OPENCASTPROJECT_TENANT1_ADMIN_UI_URL=$PROP_ORG_OPENCASTPROJECT_TENANT1_ADMIN_UI_URL \
    PROP_ORG_OPENCASTPROJECT_TENANT2_ADMIN_UI_URL=$PROP_ORG_OPENCASTPROJECT_TENANT2_ADMIN_UI_URL \
    OPENCAST_PRESENTATION_URL=$OPENCAST_PRESENTATION_URL \
    PROP_ORG_OPENCASTPROJECT_TENANT1_PRESENTATION_UI_URL=$PROP_ORG_OPENCASTPROJECT_TENANT1_PRESENTATION_UI_URL \
    PROP_ORG_OPENCASTPROJECT_TENANT2_PRESENTATION_UI_URL=$PROP_ORG_OPENCASTPROJECT_TENANT2_PRESENTATION_UI_URL \
    ORG_OPENCASTPROJECT_DOWNLOAD_URL=$ORG_OPENCASTPROJECT_DOWNLOAD_URL \
    ORG_OPENCASTPROJECT_SECURITY_ADMIN_USER=$ORG_OPENCASTPROJECT_SECURITY_ADMIN_USER \
    ORG_OPENCASTPROJECT_SECURITY_ADMIN_PASS=$ORG_OPENCASTPROJECT_SECURITY_ADMIN_PASS \
    ORG_OPENCASTPROJECT_ADMIN_EMAIL=$ORG_OPENCASTPROJECT_ADMIN_EMAIL \
    ORG_OPENCASTPROJECT_SECURITY_DIGEST_USER=$ORG_OPENCASTPROJECT_SECURITY_DIGEST_USER \
    ORG_OPENCASTPROJECT_SECURITY_DIGEST_PASS=$ORG_OPENCASTPROJECT_SECURITY_DIGEST_PASS \
    OPENCAST_DATA=$OPENCAST_DATA \
    ORG_OPENCASTPROJECT_DB_DDL_GENERATION=$ORG_OPENCASTPROJECT_DB_DDL_GENERATION \
    ORG_OPENCASTPROJECT_DB_JDBC_DRIVER=$ORG_OPENCASTPROJECT_DB_JDBC_DRIVER \
    ORG_OPENCASTPROJECT_DB_VENDOR=$ORG_OPENCASTPROJECT_DB_VENDOR \
    ORG_OPENCASTPROJECT_DB_JDBC_URL=$ORG_OPENCASTPROJECT_DB_JDBC_URL \
    ORG_OPENCASTPROJECT_DB_JDBC_USER=$ORG_OPENCASTPROJECT_DB_JDBC_USER \
    ORG_OPENCASTPROJECT_DB_JDBC_PASS=$ORG_OPENCASTPROJECT_DB_JDBC_PASS \
    ACTIVEMQ_BROKER_URL=$ACTIVEMQ_BROKER_URL \
    ACTIVEMQ_BROKER_USERNAME=$ACTIVEMQ_BROKER_USERNAME \
    ACTIVEMQ_BROKER_PASSWORD=$ACTIVEMQ_BROKER_PASSWORD
ENV PROP_ORG_OPENCASTPROJECT_FILE_REPO_URL=$OPENCAST_ADMIN_URL \
    PROP_ORG_OPENCASTPROJECT_ADMIN_UI_URL=$OPENCAST_ADMIN_URL \
    PROP_ORG_OPENCASTPROJECT_ENGAGE_UI_URL=$OPENCAST_PRESENTATION_URL

ENV LANG="C.UTF-8" \
    JAVA_HOME="/usr/lib/jvm/java-1.8-openjdk" \
    PATH="$PATH:/usr/lib/jvm/java-1.8-openjdk/jre/bin:/usr/lib/jvm/java-1.8-openjdk/bin" \
    HUNSPELL_BASE_URL="http://download.services.openoffice.org/contrib/dictionaries" \
    OPENCAST_HOME="/opt/opencast" \
    OPENCAST_BUILD="/opencast" \
    OPENCAST_USER="opencast" \
    OPENCAST_GROUP="opencast" \
    OPENCAST_UID="800" \
    OPENCAST_GID="800"
ENV OPENCAST_SCRIPTS="${OPENCAST_HOME}/docker/scripts" \
    OPENCAST_CONFIG="${OPENCAST_HOME}/etc"


RUN addgroup -S -g "${OPENCAST_GID}" "${OPENCAST_GROUP}" && \
    adduser -S -D -H -G "${OPENCAST_GROUP}" -h "${OPENCAST_HOME}" -u "${OPENCAST_UID}" "${OPENCAST_USER}" && \
    mkdir -p "${OPENCAST_DATA}" && \
    mkdir -p "${OPENCAST_HOME}"

COPY assets/scripts "${OPENCAST_SCRIPTS}"
COPY assets/etc/ "${OPENCAST_HOME}/etc-temp/"
COPY assets/docker-entrypoint.sh assets/docker-healthcheck.sh /

RUN mkdir -p /tmp/hunspell /usr/share/hunspell && \
     { \
       echo "22e217a631977d7b377f8dd22d2bbacd2d36b32765ce13f3474b03a4a97dd700  en_AU.zip"; \
       echo "31fac12a1b520cde686f328d3fa7560f6eba772cddc872197ff842c57a0dc1ea  en_CA.zip"; \
       echo "5869d8bd80eb2eb328ebe36b356348de4ae2acb1db6df39d1717d33f89f63728  en_GB.zip"; \
       echo "6cc717b4de43240595662a2deef5447b06062e82380f5647196f07c9089284fa  en_NZ.zip"; \
       echo "9227f658f182c9cece797352f041a888134765c11bffc91951c010a73187baea  en_US.zip"; \
       echo "090285b721dcaabff51b467123f82a181a6904d187c90bda812c6e5f365ff19a  en_ZA.zip"; \
     } > /tmp/hunspell-sha256sum.txt && \
     cd /tmp/hunspell && \
     for file in $(awk '{print $2}' /tmp/hunspell-sha256sum.txt); do \
       curl -L -o "${file}" "${HUNSPELL_BASE_URL}/${file}"; \
       grep "${file}" /tmp/hunspell-sha256sum.txt | sha256sum -c -; \
       unzip "/tmp/hunspell/${file}"; \
     done && \
     cp *.aff *.dic /usr/share/hunspell && \
     rm -rf /tmp/*
RUN "${OPENCAST_SCRIPTS}"/sudo.sh
